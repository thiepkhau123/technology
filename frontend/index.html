<!DOCTYPE html>
<html lang="vi">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Technology Shop | Premium Tech</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  <style>
    body {
      font-family: 'Inter', sans-serif;
    }

    .no-scrollbar::-webkit-scrollbar {
      display: none;
    }

    .cat-btn.active {
      background-color: white;
      color: #2563eb;
      box-shadow: 0 10px 15px -3px rgba(37, 99, 235, 0.1);
    }

    .product-card:hover {
      transform: translateY(-8px);
    }
  </style>
</head>

<body class="bg-slate-50 min-h-screen">

  <header id="header-placeholder" class="bg-white shadow-sm border-b border-gray-100 sticky top-0 z-50"></header>

  <main class="max-w-6xl mx-auto px-6 py-12">
    <section
      class="bg-white rounded-[2.5rem] p-8 md:p-12 mb-12 shadow-2xl shadow-slate-200/60 border border-slate-100 flex flex-col md:flex-row items-center gap-12">
      <div class="flex-1">
        <div
          class="inline-block px-4 py-1.5 bg-blue-50 text-blue-600 rounded-full text-xs font-black uppercase tracking-widest mb-6">
          Hàng chính hãng 100%
        </div>
        <h2 class="text-4xl md:text-5xl font-black text-slate-900 mb-6 leading-tight">
          Kho Công Nghệ <span class="text-blue-600 italic">Premium</span>
        </h2>
        <p class="text-slate-500 mb-8 text-lg font-medium">Trải nghiệm mua sắm thiết bị AI và linh kiện cao cấp nhất
          hiện nay.</p>
        <div class="relative max-w-md group">
          <i
            class="fas fa-search absolute left-5 top-1/2 -translate-y-1/2 text-slate-400 group-focus-within:text-blue-500 transition"></i>
          <input type="text" id="searchInput" oninput="filterProducts()" placeholder="Tìm tên sản phẩm..."
            class="w-full pl-14 pr-6 py-5 bg-slate-50 border-2 border-transparent rounded-[1.5rem] focus:bg-white focus:border-blue-500 focus:ring-4 focus:ring-blue-500/10 outline-none transition-all shadow-inner font-medium">
        </div>
      </div>
      <div class="w-full md:w-auto grid grid-cols-2 gap-6">
        <div class="bg-blue-600 p-8 rounded-[2.5rem] text-center shadow-xl shadow-blue-200">
          <p class="text-4xl font-black text-white" id="total-count">0</p>
          <p class="text-[10px] font-bold text-blue-100 uppercase tracking-widest mt-2">Sản phẩm</p>
        </div>
        <div class="bg-slate-900 p-8 rounded-[2.5rem] text-center shadow-xl shadow-slate-300">
          <p class="text-4xl font-black text-white italic">24/7</p>
          <p class="text-[10px] font-bold text-slate-400 uppercase tracking-widest mt-2">Hỗ trợ</p>
        </div>
      </div>
    </section>

    <div class="flex flex-col md:flex-row items-center justify-between gap-6 mb-12">
      <div
        class="flex gap-2 p-1.5 bg-slate-200/60 backdrop-blur-md rounded-[1.5rem] w-full md:w-fit overflow-x-auto no-scrollbar border border-slate-200">
        <button onclick="setCategory('all', event)"
          class="cat-btn active px-8 py-3 rounded-2xl font-black text-xs uppercase tracking-wider transition-all">Tất
          cả</button>
        <button onclick="setCategory('phone', event)"
          class="cat-btn px-8 py-3 rounded-2xl font-black text-xs uppercase tracking-wider transition-all text-slate-500 hover:text-slate-900">Điện
          thoại</button>
        <button onclick="setCategory('component', event)"
          class="cat-btn px-8 py-3 rounded-2xl font-black text-xs uppercase tracking-wider transition-all text-slate-500 hover:text-slate-900">Linh
          kiện</button>
        <button onclick="setCategory('account', event)"
          class="cat-btn px-8 py-3 rounded-2xl font-black text-xs uppercase tracking-wider transition-all text-slate-500 hover:text-slate-900">Tài
          khoản AI</button>
      </div>
      <p class="text-xs text-slate-400 font-bold uppercase tracking-widest whitespace-nowrap">
        Hiển thị: <span id="display-count" class="text-blue-600 font-black ml-1">0</span> sản phẩm
      </p>
    </div>

    <div id="product-grid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-8">
      <div class="animate-pulse bg-white h-96 rounded-[2.5rem] border border-slate-100"></div>
      <div class="animate-pulse bg-white h-96 rounded-[2.5rem] border border-slate-100"></div>
      <div class="animate-pulse bg-white h-96 rounded-[2.5rem] border border-slate-100"></div>
      <div class="animate-pulse bg-white h-96 rounded-[2.5rem] border border-slate-100"></div>
    </div>
  </main>

  <div id="footer-placeholder"></div>

  <script src="js/auth.js"></script>

  <script>
    let allProducts = [];
    let currentCategory = 'all';
    const API_BASE = 'http://localhost:4000/api';

    // 1. TẢI COMPONENTS
    async function loadComponents() {
      try {
        const [h, f] = await Promise.all([
          fetch('header.html').then(r => r.text()),
          fetch('footer.html').then(r => r.text())
        ]);
        document.getElementById('header-placeholder').innerHTML = h;
        document.getElementById('footer-placeholder').innerHTML = f;

        if (typeof checkAuth === "function") checkAuth();
        updateCartBadge();
      } catch (err) {
        console.error("Lỗi giao diện:", err);
      }
    }

    function updateCartBadge() {
      const cartCount = document.getElementById('cart-count');
      const cart = JSON.parse(localStorage.getItem('cart')) || [];
      if (cartCount) cartCount.innerText = cart.length;
    }

    // 2. LẤY DỮ LIỆU
    async function fetchAllProducts() {
      try {
        const response = await fetch(`${API_BASE}/products/all`);
        if (!response.ok) throw new Error();
        allProducts = await response.json();

        document.getElementById('total-count').innerText = allProducts.length;
        renderProducts(allProducts);
      } catch (error) {
        document.getElementById('product-grid').innerHTML = `
                    <div class="col-span-full text-center py-20">
                        <i class="fas fa-server text-4xl text-red-300 mb-4"></i>
                        <p class="text-red-500 font-black uppercase tracking-tighter">Lỗi kết nối Server!</p>
                    </div>`;
      }
    }

    // 3. HIỂN THỊ SẢN PHẨM
    function renderProducts(products) {
      const container = document.getElementById('product-grid');
      if (!products || products.length === 0) {
        container.innerHTML = `<p class="col-span-full text-center py-20 text-slate-400 font-bold">Không tìm thấy sản phẩm...</p>`;
        document.getElementById('display-count').innerText = 0;
        return;
      }

      container.innerHTML = products.map(p => {
        const img = (p.image_url && p.image_url !== 'NULL' && p.image_url !== 'EMPTY')
          ? p.image_url
          : 'assets/noimage.png';
        const price = Number(p.price || 0).toLocaleString();
        const displayName = p.name || `${p.provider || ''} ${p.plan || ''}`;

        return `
                <div onclick="goToDetail('${p.id}', '${p.category}')" 
                     class="product-card group bg-white rounded-[2.5rem] p-6 shadow-xl shadow-slate-200/50 border border-slate-100 transition-all duration-500 cursor-pointer">
                    <div class="relative h-56 mb-6 bg-slate-50 rounded-[2rem] overflow-hidden flex items-center justify-center p-8 border border-slate-50">
                        <img src="${img}" onerror="this.src='assets/noimage.png'" alt="${displayName}"
                             class="max-h-full object-contain group-hover:scale-110 transition duration-700">
                        <div class="absolute top-4 right-4 bg-white/90 backdrop-blur-sm px-3 py-1 rounded-full text-[9px] font-black uppercase tracking-widest text-blue-600 border border-blue-50">
                            ${p.category}
                        </div>
                    </div>  
                    <h3 class="text-lg font-black text-slate-900 mb-3 line-clamp-1 group-hover:text-blue-600 transition tracking-tight">${displayName}</h3>
                    <div class="flex items-center justify-between mt-auto">
                        <span class="text-2xl font-black text-blue-600 tracking-tighter">${price}đ</span>
                        <div class="w-10 h-10 bg-slate-900 text-white rounded-xl flex items-center justify-center group-hover:bg-blue-600 transition shadow-lg">
                            <i class="fas fa-plus text-[10px]"></i>
                        </div>
                    </div>
                </div>`;
      }).join('');

      document.getElementById('display-count').innerText = products.length;
    }

    // 4. ĐIỀU HƯỚNG
    function goToDetail(id, category) {
      if (!id || !category) return;

      // Lưu dự phòng vào sessionStorage để chống Redirect làm mất URL
      sessionStorage.setItem('last_product_id', id);
      sessionStorage.setItem('last_product_cat', category);

      // Chuyển hướng (giữ nguyên .html để hạn chế Server Redirect)
      window.location.href = `product-detail.html?id=${id}&cat=${category}`;
    }

    // 5. LỌC SẢN PHẨM
    function setCategory(cat, event) {
      currentCategory = cat;
      document.querySelectorAll('.cat-btn').forEach(btn => btn.classList.remove('active'));
      event.currentTarget.classList.add('active');
      filterProducts();
    }

    function filterProducts() {
      const term = document.getElementById('searchInput').value.toLowerCase();
      const filtered = allProducts.filter(p => {
        const nameMatch = (p.name || p.provider || '').toLowerCase().includes(term);
        const categoryMatch = (currentCategory === 'all' || p.category === currentCategory);
        return nameMatch && categoryMatch;
      });
      renderProducts(filtered);
    }

    // KHỞI CHẠY
    document.addEventListener('DOMContentLoaded', () => {
      loadComponents();
      fetchAllProducts();
    });
  </script>
</body>

</html>