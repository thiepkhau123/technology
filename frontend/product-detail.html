<!DOCTYPE html>
<html lang="vi">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Chi ti·∫øt s·∫£n ph·∫©m | TechShop</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  <style>
    body { font-family: 'Inter', sans-serif; }
    .product-image-container:hover img { transform: scale(1.05); }
    @keyframes modal-in { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
    .animate-modal { animation: modal-in 0.3s ease-out forwards; }
    .input-field { width: 100%; padding: 12px 16px; background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 1rem; outline: none; transition: all 0.2s; font-size: 0.875rem; }
    .input-field:focus { border-color: #2563eb; box-shadow: 0 0 0 2px #dbeafe; }
  </style>
</head>

<body class="bg-slate-50 min-h-screen text-slate-800">
  <header id="header-placeholder" class="bg-white shadow-sm border-b border-gray-100 sticky top-0 z-50"></header>

  <main class="max-w-6xl mx-auto px-6 py-12">
    <a href="index.html" class="inline-flex items-center gap-2 text-slate-500 hover:text-blue-600 mb-8 font-bold transition-all hover:-translate-x-1">
      <i class="fas fa-arrow-left"></i> Quay l·∫°i c·ª≠a h√†ng
    </a>

    <div id="product-content" class="bg-white rounded-[3rem] p-6 md:p-12 shadow-2xl shadow-slate-200/60 border border-slate-100 flex flex-col md:flex-row gap-12 min-h-[500px]">
      <div class="animate-pulse flex flex-col md:flex-row gap-12 w-full">
        <div class="bg-slate-100 h-[400px] w-full md:w-1/2 rounded-[2.5rem]"></div>
        <div class="flex-1 space-y-6 py-4">
          <div class="h-4 bg-slate-100 rounded w-1/4"></div>
          <div class="h-12 bg-slate-100 rounded w-3/4"></div>
          <div class="h-32 bg-slate-100 rounded w-full"></div>
        </div>
      </div>
    </div>
  </main>

  <div id="payment-modal" class="fixed inset-0 bg-slate-900/60 backdrop-blur-sm z-[100] hidden items-center justify-center p-4 overflow-y-auto">
    <div class="bg-white rounded-[2.5rem] max-w-4xl w-full p-8 md:p-10 shadow-2xl relative animate-modal my-auto">
      <button onclick="closePaymentModal()" class="absolute top-6 right-6 text-slate-400 hover:text-slate-600 transition">
        <i class="fas fa-times text-xl"></i>
      </button>

      <div class="grid grid-cols-1 md:grid-cols-2 gap-10">
        <div class="text-center md:border-r border-slate-100 md:pr-10">
          <h3 class="text-xl font-black text-slate-900 mb-4 uppercase">Qu√©t m√£ VietQR</h3>
          <div class="bg-slate-50 p-4 rounded-3xl border border-dashed border-slate-200 mb-6">
            <img id="qr-code-img" src="" alt="QR Code" class="mx-auto w-full max-w-[240px] aspect-square object-contain">
          </div>
          <div class="space-y-3 text-left bg-blue-50/50 p-5 rounded-2xl border border-blue-100">
            <div class="flex justify-between text-sm"><span class="text-slate-500">S·ªë ti·ªÅn:</span><b id="pay-amount" class="text-blue-600 text-lg">0ƒë</b></div>
            <div class="flex justify-between text-sm"><span class="text-slate-500">N·ªôi dung:</span><b id="pay-content" class="text-slate-900 uppercase tracking-widest">TS ORDER</b></div>
          </div>
        </div>

        <div class="flex flex-col justify-center">
          <h3 class="text-xl font-black text-slate-900 mb-4 uppercase" id="shipping-title">Th√¥ng tin giao h√†ng</h3>
          <div id="shipping-form" class="space-y-4">
            <div id="physical-fields" class="hidden space-y-4">
              <p class="text-sm text-slate-500 mb-2 font-medium italic">* Vui l√≤ng nh·∫≠p ƒë·ªãa ch·ªâ ƒë·ªÉ TechShop giao h√†ng t·∫≠n n∆°i:</p>
              <input type="text" id="ship-name" placeholder="H·ªç v√† t√™n ng∆∞·ªùi nh·∫≠n" class="input-field">
              <input type="tel" id="ship-phone" placeholder="S·ªë ƒëi·ªán tho·∫°i li√™n h·ªá" class="input-field">
              <textarea id="ship-address" placeholder="ƒê·ªãa ch·ªâ chi ti·∫øt (S·ªë nh√†, ƒë∆∞·ªùng, ph∆∞·ªùng, t·ªânh...)" class="input-field h-24 resize-none"></textarea>
            </div>

            <div id="digital-fields" class="hidden">
              <div class="p-5 bg-blue-50 border border-blue-100 rounded-2xl text-blue-800 flex gap-4">
                <i class="fas fa-info-circle text-xl mt-1"></i>
                <p class="text-sm leading-relaxed">S·∫£n ph·∫©m n√†y s·∫Ω ƒë∆∞·ª£c g·ª≠i <b>T√†i kho·∫£n/Key</b> tr·ª±c ti·∫øp v√†o m·ª•c <b>L·ªãch s·ª≠ ƒë∆°n h√†ng</b> c·ªßa b·∫°n sau khi thanh to√°n.</p>
              </div>
            </div>
          </div>

          <button onclick="confirmPaid()" id="btn-confirm-pay" class="mt-8 w-full bg-slate-900 text-white py-5 rounded-2xl font-black hover:bg-blue-600 transition shadow-xl active:scale-95 flex items-center justify-center gap-2">
            X√ÅC NH·∫¨N ƒê√É CHUY·ªÇN KHO·∫¢N
          </button>
        </div>
      </div>
    </div>
  </div>

  <div id="footer-placeholder"></div>

  <script src="js/auth.js"></script>
  <script>
    const API_BASE = typeof API_URL !== 'undefined' ? API_URL : 'http://localhost:4000/api';
    let currentProduct = null;

    function getURLParams() {
      const params = new URLSearchParams(window.location.search);
      return { 
        id: params.get('id') || sessionStorage.getItem('last_product_id'), 
        cat: params.get('cat') || sessionStorage.getItem('last_product_cat') 
      };
    }

    async function loadComponents() {
      try {
        const [h, f] = await Promise.all([
          fetch('/header.html').then(res => res.text()),
          fetch('/footer.html').then(res => res.text())
        ]);
        document.getElementById('header-placeholder').innerHTML = h;
        document.getElementById('footer-placeholder').innerHTML = f;
        if (typeof checkAuth === "function") await checkAuth();
        updateCartBadge();
      } catch (err) { console.warn("L·ªói n·∫°p template"); }
    }

    async function loadProductDetail(id, cat) {
      try {
        const res = await fetch(`${API_BASE}/products/${cat}/${id}`);
        const data = await res.json();
        currentProduct = Array.isArray(data) ? data[0] : data;
        renderDetail(currentProduct, cat);
      } catch (err) { showError("Kh√¥ng t√¨m th·∫•y s·∫£n ph·∫©m."); }
    }

    function renderDetail(p, cat) {
      const name = p.name || `${p.provider || ''} ${p.plan || ''}`;
      const price = Number(p.price || 0);
      const img = (p.image_url && p.image_url !== 'NULL' && p.image_url !== 'EMPTY') ? p.image_url : `https://via.placeholder.com/600x600?text=TechShop`;
      
      document.getElementById('product-content').innerHTML = `
        <div class="w-full md:w-1/2 product-image-container overflow-hidden rounded-[2.5rem] bg-slate-50 flex items-center justify-center p-8 border border-slate-50 shadow-inner">
            <img src="${img}" class="w-full h-full object-contain transition duration-700 hover:scale-105">
        </div>
        <div class="flex-1 flex flex-col justify-center">
            <div class="mb-6 flex items-center gap-3">
                <span class="px-4 py-1.5 bg-blue-600 text-white rounded-full text-[10px] font-black uppercase tracking-widest">${p.category || cat}</span>
            </div>
            <h1 class="text-4xl md:text-5xl font-black text-slate-900 mb-4 leading-tight">${name}</h1>
            <div class="flex items-center gap-4 mb-8">
                <span class="text-4xl font-black text-blue-600 tracking-tighter">${price.toLocaleString()}ƒë</span>
                <span class="text-green-500 font-bold text-sm"><i class="fas fa-box mr-1"></i> C√≤n h√†ng</span>
            </div>
            <div class="bg-slate-50 p-6 rounded-3xl border border-slate-100 mb-8 font-medium text-slate-600">
                ${p.description || p.note || 'S·∫£n ph·∫©m c√¥ng ngh·ªá cao c·∫•p.'}
            </div>
            <div class="flex flex-col sm:flex-row gap-4">
                <button onclick="addToCart()" class="flex-1 border-2 border-slate-900 text-slate-900 py-5 rounded-2xl font-black hover:bg-slate-50 transition active:scale-95">TH√äM V√ÄO GI·ªé</button>
                <button onclick="openPayment()" class="flex-1 bg-slate-900 text-white py-5 rounded-2xl font-black text-lg hover:bg-blue-600 transition shadow-xl active:scale-95">THANH TO√ÅN NGAY</button>
            </div>
        </div>`;
    }

    function openPayment() {
      if (!localStorage.getItem('access_token')) {
        alert("Vui l√≤ng ƒëƒÉng nh·∫≠p!"); window.location.href = 'login.html'; return;
      }

      const { cat } = getURLParams();
      const catLower = (cat || "").toLowerCase();
      
      // D·ª±a v√†o d·ªØ li·ªáu h√¨nh ·∫£nh DB b·∫°n g·ª≠i: phone, component l√† h√†ng v·∫≠t l√Ω
      const isPhysical = ['phone', 'component'].includes(catLower);

      document.getElementById('physical-fields').classList.toggle('hidden', !isPhysical);
      document.getElementById('digital-fields').classList.toggle('hidden', isPhysical);
      document.getElementById('shipping-title').innerText = isPhysical ? "ƒê·ªäA CH·ªà NH·∫¨N H√ÄNG" : "NH·∫¨N H√ÄNG QUA T√ÄI KHO·∫¢N";

      const orderCode = `TS${Math.floor(100000 + Math.random() * 900000)}`;
      const qrUrl = `https://img.vietqr.io/image/VCB-1014363257-compact.png?amount=${currentProduct.price}&addInfo=${orderCode}&accountName=Khau%20Tran%20Ngoc%20Thiep`;

      document.getElementById('qr-code-img').src = qrUrl;
      document.getElementById('pay-amount').innerText = Number(currentProduct.price).toLocaleString() + 'ƒë';
      document.getElementById('pay-content').innerText = orderCode;
      document.getElementById('payment-modal').classList.replace('hidden', 'flex');
    }

    async function confirmPaid() {
      const { cat } = getURLParams();
      const isPhysical = ['phone', 'component'].includes((cat || "").toLowerCase());
      let note = `N·ªôi dung CK: ${document.getElementById('pay-content').innerText}`;

      if (isPhysical) {
        const name = document.getElementById('ship-name').value.trim();
        const phone = document.getElementById('ship-phone').value.trim();
        const addr = document.getElementById('ship-address').value.trim();
        if(!name || !phone || !addr) { alert("Vui l√≤ng nh·∫≠p ƒë·ªß th√¥ng tin giao h√†ng!"); return; }
        note += ` | Ship: ${name} - ${phone} - ${addr}`;
      }

      const btn = document.getElementById('btn-confirm-pay');
      btn.disabled = true;
      btn.innerHTML = `<i class="fas fa-spinner fa-spin mr-2"></i> ƒêANG X·ª¨ L√ù...`;

      try {
        const res = await fetch(`${API_BASE}/orders`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${localStorage.getItem('access_token')}` },
          body: JSON.stringify({
            product_id: currentProduct.id,
            category: cat,
            total_price: currentProduct.price,
            payment_method: 'online_banking',
            status: 'pending',
            note: note
          })
        });
        if (res.ok) { alert("üéâ ƒê·∫∑t h√†ng th√†nh c√¥ng!"); window.location.href = 'index.html'; }
      } catch (err) { alert("L·ªói k·∫øt n·ªëi!"); btn.disabled = false; btn.innerHTML = "X√ÅC NH·∫¨N ƒê√É CHUY·ªÇN KHO·∫¢N"; }
    }

    function closePaymentModal() { document.getElementById('payment-modal').classList.replace('flex', 'hidden'); }
    function updateCartBadge() { /* ...gi·ªØ nguy√™n logic c≈©... */ }
    function addToCart() { /* ...gi·ªØ nguy√™n logic c≈©... */ }

    async function initPage() {
      const { id, cat } = getURLParams();
      await loadComponents();
      if (id && cat) await loadProductDetail(id, cat);
    }
    document.addEventListener('DOMContentLoaded', initPage);
  </script>
</body>
</html>