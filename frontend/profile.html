<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hồ sơ cá nhân | TechShop</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;900&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }

        ::-webkit-scrollbar {
            width: 6px;
        }

        ::-webkit-scrollbar-track {
            background: #f1f1f1;
        }

        ::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 10px;
        }
    </style>
</head>

<body class="bg-slate-50 min-h-screen">

    <header id="header-placeholder" class="bg-white shadow-sm border-b border-gray-100 sticky top-0 z-50"></header>

    <div class="max-w-4xl mx-auto py-12 px-4">
        <div class="mb-8">
            <a href="index.html"
                class="group text-slate-500 hover:text-blue-600 font-bold text-sm transition-all flex items-center gap-2 w-fit">
                <i class="fas fa-arrow-left transition-transform group-hover:-translate-x-1"></i>
                Quay lại trang chủ
            </a>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
            <div class="md:col-span-1">
                <div
                    class="bg-white rounded-[2.5rem] p-8 shadow-xl shadow-slate-200/50 border border-slate-100 text-center sticky top-24">
                    <div class="relative w-32 h-32 mx-auto mb-6">
                        <div id="avatar-bg"
                            class="w-full h-full rounded-[2.5rem] bg-gradient-to-tr from-blue-600 to-indigo-400 flex items-center justify-center text-white text-4xl font-black shadow-lg shadow-blue-200 uppercase">
                            <span id="avatar-placeholder">?</span>
                        </div>
                        <div
                            class="absolute -bottom-2 -right-2 w-10 h-10 bg-white rounded-2xl shadow-md flex items-center justify-center text-blue-600 border border-slate-50">
                            <i class="fas fa-check-circle"></i>
                        </div>
                    </div>

                    <h2 id="display-name" class="text-xl font-black text-slate-800 mb-1 truncate px-2 italic">...</h2>
                    <div id="display-role"
                        class="inline-block px-4 py-1 rounded-full text-[10px] font-black uppercase tracking-widest bg-slate-100 text-slate-500">
                        ...</div>

                    <hr class="my-6 border-slate-100">

                    <div class="text-left space-y-4 px-2">
                        <div>
                            <p class="text-[10px] font-bold text-slate-400 uppercase tracking-widest mb-1">Email</p>
                            <p id="display-email" class="text-sm font-semibold text-slate-700 truncate">...</p>
                        </div>
                        <div>
                            <p class="text-[10px] font-bold text-slate-400 uppercase tracking-widest mb-1">Thành viên từ
                            </p>
                            <p id="display-joined" class="text-sm font-semibold text-slate-700">...</p>
                        </div>
                    </div>
                </div>
            </div>

            <div class="md:col-span-2 space-y-8">
                <div
                    class="bg-white rounded-[2.5rem] p-8 md:p-10 shadow-xl shadow-slate-200/50 border border-slate-100 transition-all hover:shadow-2xl hover:shadow-slate-200/60">
                    <h3 class="text-lg font-black text-slate-800 mb-8 flex items-center gap-3">
                        <div class="w-10 h-10 bg-blue-50 text-blue-600 rounded-xl flex items-center justify-center">
                            <i class="fas fa-user-edit"></i>
                        </div>
                        Cập nhật hồ sơ
                    </h3>
                    <div class="space-y-6">
                        <div>
                            <label
                                class="block text-[10px] font-black text-slate-400 uppercase tracking-[0.15em] mb-2 ml-1">Họ
                                và tên của bạn</label>
                            <input type="text" id="input-name" placeholder="Ví dụ: Nguyễn Văn A"
                                class="w-full px-6 py-4 bg-slate-50 border border-slate-100 rounded-2xl focus:outline-none focus:ring-4 focus:ring-blue-500/10 focus:border-blue-500 transition-all font-semibold text-slate-700">
                        </div>
                        <button onclick="updateProfile()" id="btn-update"
                            class="w-full bg-blue-600 hover:bg-blue-700 text-white font-black text-xs uppercase tracking-[0.2em] py-5 rounded-2xl transition-all shadow-lg shadow-blue-200 active:scale-[0.98]">
                            Lưu thay đổi
                        </button>
                    </div>
                </div>

                <div
                    class="bg-white rounded-[2.5rem] p-8 md:p-10 shadow-xl shadow-slate-200/50 border border-slate-100 transition-all hover:shadow-2xl hover:shadow-slate-200/60">
                    <h3 class="text-lg font-black text-slate-800 mb-8 flex items-center gap-3">
                        <div class="w-10 h-10 bg-amber-50 text-amber-500 rounded-xl flex items-center justify-center">
                            <i class="fas fa-shield-alt"></i>
                        </div>
                        Bảo mật tài khoản
                    </h3>
                    <div class="space-y-6">
                        <div>
                            <label
                                class="block text-[10px] font-black text-slate-400 uppercase tracking-[0.15em] mb-2 ml-1">Mật
                                khẩu mới</label>
                            <input type="password" id="new-password" placeholder="Tối thiểu 6 ký tự"
                                class="w-full px-6 py-4 bg-slate-50 border border-slate-100 rounded-2xl focus:outline-none focus:ring-4 focus:ring-amber-500/10 focus:border-amber-500 transition-all font-semibold text-slate-700">
                        </div>
                        <button onclick="changePassword()" id="btn-password"
                            class="w-full bg-slate-800 hover:bg-black text-white font-black text-xs uppercase tracking-[0.2em] py-5 rounded-2xl transition-all shadow-lg active:scale-[0.98]">
                            Đổi mật khẩu
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="footer-placeholder"></div>
    <div id="status" class="fixed bottom-8 right-8 hidden z-[100]"></div>
    
    <script src="js/auth.js"></script>
    <script>
        const API_BASE = 'http://localhost:4000/api';
        const token = localStorage.getItem('access_token');

        window.onload = async () => {
            if (!token) {
                window.location.href = 'login.html';
                return;
            }

            // BƯỚC 1: Load Header và Footer trước
            await loadLayout();

            // BƯỚC 2: Sau khi Header đã có trong DOM, chạy checkAuth để hiện các nút Đơn hàng/Hồ sơ
            // Lưu ý: Đảm bảo file auth.js đã được nhúng vào profile.html
            if (typeof checkAuth === 'function') {
                await checkAuth();
            }

            // BƯỚC 3: Đổ dữ liệu riêng cho trang Profile
            await fetchUserData();
        };

        async function loadLayout() {
            try {
                const [h, f] = await Promise.all([fetch('header.html'), fetch('footer.html')]);
                document.getElementById('header-placeholder').innerHTML = await h.text();
                document.getElementById('footer-placeholder').innerHTML = await f.text();
            } catch (err) { console.error("Layout error:", err); }
        }

        function syncUIName(name) {
            const finalName = name || "Thành viên";

            // Cập nhật tên hiển thị Profile
            const displayEl = document.getElementById('display-name');
            if (displayEl) displayEl.innerText = finalName;

            // Cập nhật chữ cái đầu Avatar
            const avatarEl = document.getElementById('avatar-placeholder');
            if (avatarEl) avatarEl.innerText = finalName.charAt(0).toUpperCase();

            // Cập nhật Header (nếu đã load xong)
            const headerUser = document.getElementById('username');
            if (headerUser) headerUser.innerText = finalName;

            localStorage.setItem('user_fullname', finalName);
        }

        async function fetchUserData() {
            try {
                const res = await fetch(`${API_BASE}/me`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if (!res.ok) throw new Error("Session expired");

                const profile = await res.json();

                // Logic xử lý tên: profiles.full_name -> email prefix -> Default
                let nameDisplay = "Thành viên";
                if (profile.full_name && profile.full_name.trim() !== "" && profile.full_name.toUpperCase() !== "NULL") {
                    nameDisplay = profile.full_name;
                } else if (profile.email) {
                    nameDisplay = profile.email.split('@')[0];
                }

                syncUIName(nameDisplay);

                // Cập nhật các thông tin khác
                document.getElementById('display-email').innerText = profile.email;
                document.getElementById('input-name').value = (profile.full_name && profile.full_name.toUpperCase() !== "NULL") ? profile.full_name : '';

                const roleEl = document.getElementById('display-role');
                const isAdmin = profile.role === 'admin' || profile.email === 'ngocthiep213@gmail.com';
                roleEl.innerText = isAdmin ? 'Quản trị viên' : 'Thành viên';
                roleEl.className = `inline-block px-4 py-1 rounded-full text-[10px] font-black uppercase tracking-widest ${isAdmin ? 'bg-red-100 text-red-600' : 'bg-blue-100 text-blue-600'}`;

                if (profile.created_at) {
                    document.getElementById('display-joined').innerText = new Date(profile.created_at).toLocaleDateString('vi-VN');
                }

            } catch (err) { logout(); }
        }

        async function updateProfile() {
            const fullName = document.getElementById('input-name').value.trim();
            const btn = document.getElementById('btn-update');

            if (!fullName) return showNotify("Vui lòng nhập họ tên", true);

            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-circle-notch fa-spin"></i> Đang lưu...';

            try {
                const res = await fetch(`${API_BASE}/profile/update`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({ full_name: fullName })
                });

                if (res.ok) {
                    showNotify("Cập nhật hồ sơ thành công!");
                    // Gọi lại fetchUserData để đồng bộ toàn bộ giao diện (bao gồm cả Header)
                    await fetchUserData();
                } else {
                    showNotify("Lỗi cập nhật từ máy chủ", true);
                }
            } catch (err) {
                showNotify("Lỗi kết nối mạng", true);
            } finally {
                btn.disabled = false;
                btn.innerText = "Lưu thay đổi";
            }
        }

        async function changePassword() {
            const newPass = document.getElementById('new-password').value;
            const btn = document.getElementById('btn-password');
            if (newPass.length < 6) return showNotify("Mật khẩu tối thiểu 6 ký tự", true);

            btn.disabled = true;
            try {
                const res = await fetch(`${API_BASE}/profile/change-password`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                    body: JSON.stringify({ password: newPass })
                });
                if (res.ok) {
                    showNotify("Đổi mật khẩu thành công!");
                    document.getElementById('new-password').value = '';
                }
            } catch (err) { showNotify("Lỗi server", true); }
            finally { btn.disabled = false; }
        }

        function showNotify(msg, isError = false) {
            const status = document.getElementById('status');
            status.textContent = msg;
            status.className = `fixed bottom-8 right-8 px-8 py-4 rounded-2xl text-sm font-bold shadow-2xl transition-all z-[100] animate-bounce ${isError ? 'bg-red-500 text-white' : 'bg-emerald-500 text-white'}`;
            status.classList.remove('hidden');
            setTimeout(() => status.classList.add('hidden'), 3000);
        }

        function logout() {
            localStorage.clear();
            window.location.href = 'login.html';
        }
    </script>
</body>

</html>